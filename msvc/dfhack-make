#!/bin/bash -e

echo "starting persistent wineserver (make)"
wineserver -p
wine64 wineboot

dir="$(pwd)"
while [[ ! -f "$dir/dfhack-msvc-env.sh" ]] && [[ "$dir" != "/" ]]; do
	dir="$(dirname "$dir")"
done
. "$dir/dfhack-msvc-env.sh"

if [[ ! -z "$DFHACK_USE_NINJA" ]]; then
	ninja "$@" <&0
else
	make -j$(nproc) "$@" <&0
fi

echo "shutting down wineserver (make)"
wineserver -k
wineserver -w
echo "wineserver terminated (make)"
